<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Finance Tracker - Smart Money Management</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f172a">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#6366f1">
    <meta name="description" content="Modern finance tracker with offline support and beautiful UI">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Finance Tracker">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Essential Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">‚Çπ</div>
                    <h1 class="logo-text">Finance Tracker</h1>
                </div>
                
                <div class="header-actions">
                    <button id="theme-toggle" class="icon-btn" aria-label="Toggle theme">
                        <svg class="theme-icon sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <svg class="theme-icon moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                    
                    <div id="connection-status" class="connection-status online">
                        <div class="status-dot"></div>
                        <span class="status-text">Online</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Balance Card -->
            <section class="balance-section">
                <div class="balance-card">
                    <div class="balance-header">
                        <h2>Current Balance</h2>
                        <div class="balance-actions">
                            <button id="refresh-btn" class="icon-btn" aria-label="Refresh balance">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="balance-amount" id="balance">‚Çπ0</div>
                    
                    <div class="balance-trend" id="balance-trend">
                        <span class="trend-text">No transactions yet</span>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <h3>Quick Add</h3>
                
                <form id="transaction-form" class="transaction-form">
                    <div class="form-row">
                        <div class="input-group">
                            <label for="amount">Amount</label>
                            <div class="input-wrapper">
                                <span class="input-prefix">‚Çπ</span>
                                <input 
                                    id="amount" 
                                    type="number" 
                                    placeholder="0.00" 
                                    step="0.01"
                                    min="0"
                                    required
                                    autocomplete="off"
                                >
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="note">Description</label>
                            <input 
                                id="note" 
                                type="text"
                                placeholder="What's this for?" 
                                maxlength="100"
                                autocomplete="off"
                            >
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" id="income-btn" class="btn btn-income">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Income
                        </button>
                        
                        <button type="button" id="expense-btn" class="btn btn-expense">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Expense
                        </button>
                    </div>
                </form>
            </section>

            <!-- Recent Transactions Preview -->
            <section class="recent-section">
                <div class="section-header">
                    <h3>Recent Transactions</h3>
                    <a href="history.html" class="view-all-btn">
                        View All
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </a>
                </div>
                
                <div id="recent-transactions" class="recent-list">
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <p>No transactions yet</p>
                        <span>Add your first transaction above</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Processing...</p>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container"></div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Home</span>
            </a>
            
            <a href="history.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4"></path>
                    <polyline points="9 11 12 14 15 11"></polyline>
                    <line x1="12" y1="2" x2="12" y2="14"></line>
                </svg>
                <span>History</span>
            </a>
            
            <button class="nav-item" id="stats-btn" onclick="window.location.href='stats.html'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                <span>Stats</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { loadData, addTx, onLoadingChange } from "./app.js";

        // DOM Elements
        const balanceEl = document.getElementById("balance");
        const amountEl = document.getElementById("amount");
        const noteEl = document.getElementById("note");
        const loadingOverlay = document.getElementById("loading-overlay");
        const connectionStatus = document.getElementById("connection-status");
        const recentTransactions = document.getElementById("recent-transactions");
        const balanceTrend = document.getElementById("balance-trend");
        const themeToggle = document.getElementById("theme-toggle");
        const refreshBtn = document.getElementById("refresh-btn");

        let isSubmitting = false;
        let currentTransactions = [];
        let deferredPrompt;

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            if (deferredPrompt && !localStorage.getItem('pwa-dismissed')) {
                const installBanner = document.createElement('div');
                installBanner.className = 'install-banner';
                installBanner.innerHTML = `
                    <div class="install-content">
                        <div class="install-icon">üì±</div>
                        <div class="install-text">
                            <div class="install-title">Install Finance Tracker</div>
                            <div class="install-subtitle">Get quick access and offline support</div>
                        </div>
                        <div class="install-actions">
                            <button class="btn btn-primary install-btn">Install</button>
                            <button class="install-close">√ó</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(installBanner);
                
                installBanner.querySelector('.install-btn').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`PWA install outcome: ${outcome}`);
                        deferredPrompt = null;
                        installBanner.remove();
                    }
                });
                
                installBanner.querySelector('.install-close').addEventListener('click', () => {
                    localStorage.setItem('pwa-dismissed', 'true');
                    installBanner.remove();
                });
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    if (installBanner.parentElement) {
                        installBanner.remove();
                    }
                }, 10000);
            }
        }

        // Theme Management - Default to dark mode
        const theme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Loading state management
        onLoadingChange((loading) => {
            loadingOverlay.style.display = loading ? 'flex' : 'none';
            refreshBtn.classList.toggle('spinning', loading);
        });

        // Connection status
        function updateConnectionStatus() {
            const isOnline = navigator.onLine;
            connectionStatus.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
            connectionStatus.querySelector('.status-text').textContent = isOnline ? 'Online' : 'Offline';
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        updateConnectionStatus();

        // Button event handlers
        document.getElementById("income-btn").addEventListener('click', () => submit(1));
        document.getElementById("expense-btn").addEventListener('click', () => submit(-1));
        refreshBtn.addEventListener('click', refresh);

        // Form validation and UX
        amountEl.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            if (value < 0) e.target.value = Math.abs(value);
            
            // Update button states
            const hasAmount = value > 0;
            document.getElementById("income-btn").disabled = !hasAmount;
            document.getElementById("expense-btn").disabled = !hasAmount;
        });

        // Enter key support
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !isSubmitting && parseFloat(amountEl.value) > 0) {
                e.preventDefault();
                submit(-1); // Default to expense
            }
        });

        async function refresh() {
            try {
                console.log('Loading transactions...');
                const txs = await loadData();
                console.log('Loaded transactions:', txs);
                
                currentTransactions = Array.isArray(txs) ? txs : [];
                updateBalance();
                updateRecentTransactions();
                updateBalanceTrend();
                
            } catch (error) {
                console.error('Error in refresh:', error);
                showToast('Failed to load data. Please try again.', 'error');
            }
        }

        function updateBalance() {
            const total = currentTransactions.reduce((s, t) => s + (t.amount || 0), 0);
            balanceEl.textContent = `‚Çπ${total.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            balanceEl.className = `balance-amount ${total >= 0 ? 'positive' : 'negative'}`;
        }

        function updateRecentTransactions() {
            if (currentTransactions.length === 0) {
                recentTransactions.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <p>No transactions yet</p>
                        <span>Add your first transaction above</span>
                    </div>
                `;
                return;
            }

            const recent = currentTransactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 3);

            recentTransactions.innerHTML = recent.map(tx => {
                const date = new Date(tx.date);
                const isIncome = tx.amount > 0;
                
                return `
                    <div class="transaction-item ${isIncome ? 'income' : 'expense'}">
                        <div class="transaction-icon">
                            ${isIncome ? '‚ÜóÔ∏è' : '‚ÜôÔ∏è'}
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-note">${tx.note || 'No description'}</div>
                            <div class="transaction-date">${date.toLocaleDateString('en-IN')}</div>
                        </div>
                        <div class="transaction-amount ${isIncome ? 'positive' : 'negative'}">
                            ${isIncome ? '+' : ''}‚Çπ${Math.abs(tx.amount).toLocaleString('en-IN')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateBalanceTrend() {
            if (currentTransactions.length === 0) {
                balanceTrend.innerHTML = '<span class="trend-text">No transactions yet</span>';
                return;
            }

            const totalIncome = currentTransactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
            const totalExpenses = currentTransactions.filter(t => t.amount < 0).reduce((s, t) => s + Math.abs(t.amount), 0);
            
            balanceTrend.innerHTML = `
                <div class="trend-item income">
                    <span class="trend-label">Income</span>
                    <span class="trend-value">+‚Çπ${totalIncome.toLocaleString('en-IN')}</span>
                </div>
                <div class="trend-item expense">
                    <span class="trend-label">Expenses</span>
                    <span class="trend-value">-‚Çπ${totalExpenses.toLocaleString('en-IN')}</span>
                </div>
            `;
        }

        async function submit(sign) {
            if (isSubmitting) return;

            const amt = parseFloat(amountEl.value);
            if (!amt || amt <= 0) {
                showToast("Please enter a valid amount", 'error');
                amountEl.focus();
                return;
            }

            isSubmitting = true;

            try {
                const tx = await addTx(amt * sign, noteEl.value.trim());
                
                // Add to current transactions for immediate UI update
                currentTransactions.unshift(tx);
                
                // Clear form
                amountEl.value = "";
                noteEl.value = "";
                
                // Update UI
                updateBalance();
                updateRecentTransactions();
                updateBalanceTrend();
                
                // Show success message
                showToast(`${sign > 0 ? 'Income' : 'Expense'} added successfully!`, 'success');
                
                // Focus back to amount input
                amountEl.focus();
                
            } catch (error) {
                console.error('Submit error:', error);
                showToast(error.message || 'Failed to add transaction. Please try again.', 'error');
            } finally {
                isSubmitting = false;
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <span>${message}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Initialize app
        refresh();
        amountEl.focus();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>